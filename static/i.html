<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>UI Kontrol Video Interaktif</title>
    <!-- Memuat library InteractJS dari CDN -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    
    <style>
        /* CSS Anda tidak perlu diubah, jadi saya persingkat di sini */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background-color: #111; }
        .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 1); color: white; display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column; z-index: 1000; cursor: pointer; }
        #start-overlay h1 { font-size: 24px; }
        .ui-container { z-index:10; position: relative; width: 100vw; height: 100vh; color: white; display: flex; flex-direction: column; justify-content: space-between; }
        .controls-wrapper { position: absolute; bottom: 40px; left: 50px; right: 50px; display: flex; justify-content: space-between; align-items: flex-end; }
        .horizontal-slider-track { position: relative; width: 200px; height: 50px; border: 2px solid #666; border-radius: 20px; display: flex; justify-content: center; align-items: center; }
        .horizontal-slider-handle { background-color: transparent; border: none; width: 70px; height: 70px; cursor: grab; touch-action: none; box-sizing: border-box; display: flex; justify-content: center; align-items: center; }
        .horizontal-slider-handle svg path { fill: #ccc; }
        .right-controls { display: flex; align-items: flex-end; gap: 15px; }
        .r-button { position: relative; width: 50px; height: 60px; background-color: #000; border-radius: 15px; border: 2px solid #666; justify-content: center; align-items: center; box-sizing: border-box; display: flex; right: 10px; }
        .vertical-slider-track { position: relative; width: 54px; height: 150px; border: 2px solid #666; border-radius: 20px; box-sizing: border-box; }
        .vertical-slider-handle { position: absolute; bottom: 0; left: 0; right: 0; margin: 0 auto; width: 50px; height: 70px; background-color: #000; border-radius: 15px; cursor: grab; touch-action: none; box-sizing: border-box; display: flex; justify-content: center; align-items: center; border: 2px solid #666; }
        .slider-handle-active { cursor: grabbing; }
        .hamburger-icon { display: flex; flex-direction: column; gap: 5px; }
        .hamburger-icon .line { width: 30px; height: 5px; background-color: #ccc; border-radius: 2px; }
        #fpv-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* Pastikan di atas body, tapi di bawah yang lain */
    background-color: #1a1a1a;
}
#remoteVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
#status {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 15px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 8px;
    font-size: 14px;
    z-index: 100; /* Di atas kontrol game */
    white-space: nowrap;
    font-family: sans-serif;
}
    </style>
</head>
<body>
        <!-- Container untuk Video FPV (ditempatkan di latar belakang) -->
    <div id="fpv-container">
        <div id="status">Status: Menunggu Koneksi...</div>
        <video id="remoteVideo" autoplay muted playsinline></video>
    </div>
    
    <div id="start-overlay" class="fullscreen-overlay">
        <h1>START</h1>
    </div>

    <div class="ui-container">
        <div class="controls-wrapper">
            <div class="left-controls">
                <div class="horizontal-slider-track">
                    <div class="horizontal-slider-handle" id="horizontal-slider">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><g><g><path d="M91.8,153.1c-6,0-12,0.1-18.1-0.1c-3.5-0.1-5,0.9-4.8,4.6c0.2,4.9,0.2,9.8,0,14.8c-0.1,1.7-0.6,4.1-1.7,4.7c-1.1,0.6-3.6-0.3-4.8-1.4c-16.7-14.4-33.3-29-49.9-43.5c-3.5-3.1-3.1-5.8,0.2-8.6c16.5-14.4,33-28.8,49.6-43.1c1.3-1.1,3.5-1.3,5.3-1.9c0.5,1.7,1.3,3.3,1.4,5c0.2,4.7,0.2,9.5,0,14.2c-0.2,4,1.2,5.5,5.3,5.4c11.7-0.2,23.4-0.1,35,0c6.3,0,7.8,1.4,7.9,7.7c0.1,11.7-0.1,23.4,0.1,35c0.1,5.2-2.4,7.2-7.3,7.2C103.8,153,97.8,153.1,91.8,153.1z"/><path d="M186.8,153.1c-13.8,0-26.6,0-39.4,0c-7.6,0-8.4-0.7-8.4-8.5c0-11.3-0.1-22.6,0-34c0-6.3,1.2-7.4,7.4-7.4c11.9,0,23.7-0.1,35.6,0c3.5,0,4.9-1.1,4.8-4.7c-0.2-5.1-0.2-10.2,0.1-15.3c0.1-1.6,0.7-3.7,1.9-4.6c0.7-0.5,3.2,0.4,4.3,1.3c17,14.7,33.8,29.5,50.7,44.3c3.1,2.7,2.8,5.1-0.1,7.7c-16.8,14.6-33.5,29.3-50.3,43.9c-1.1,0.9-3.5,2-4.2,1.4c-1.2-0.8-2.1-2.9-2.1-4.5C186.7,166.5,186.8,160.1,186.8,153.1z"/></g></g></svg>
                    </div>
                </div>
            </div>
            <div class="right-controls">
                <div class="r-button" id="belakang">                        <div class="hamburger-icon"><span class="line"></span><span class="line"></span><span class="line"></span>
                        </div>
                      </div>
                <div class="vertical-slider-track">
                    <div class="vertical-slider-handle" id="vertical-slider">
                        <div class="hamburger-icon"><span class="line"></span><span class="line"></span><span class="line"></span>
                        <span class="line"></span>
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="viewer.js" defer></script>
    <script>// --- Variabel global untuk menyimpan nilai slider ---
let horizontalSliderValue = 5; // Default di tengah (skala 0-10)
let verticalSliderValue = 0;   // Default di bawah (skala 0-10)

// --- Logika untuk Fullscreen dan Landscape ---
const startButton = document.getElementById('start-overlay');
const rootElement = document.documentElement;

startButton.addEventListener('click', () => {
    startButton.style.display = 'none';
    if (rootElement.requestFullscreen) {
        rootElement.requestFullscreen()
            .then(() => { if (screen.orientation && screen.orientation.lock) { screen.orientation.lock('landscape').catch(err => {}); } })
            .catch(err => {});
    }
});

function handleFullscreenChange() {
    if (!document.fullscreenElement) {
        startButton.style.display = 'flex';
    }
}
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

// --- BAGIAN LOGIKA MQTT & GAME ---
function mulaiWebsocket(){
  const {id_mobil} = window;
  ws = new WebSocket(`wss://${window.location.host}/mqtt/${id_mobil}?p=pemain&token=${window.location.pathname.slice(1)}`);
  ws.onopen = () => {
    console.log("sukses");
  }
  ws.onclose = (event) => {
        console.log(`Koneksi ditutup. Kode: ${event.code}, Alasan: ${event.reason}`);
        
        // Cek apakah koneksi ditutup oleh server dengan kode 'kick'
        if (event.code === 4000) {
          console.log("Sesi dicabut oleh admin. Mengarahkan...");
          // Redirect ke halaman terimakasih
          window.location.href = '/terimakasih.html';
        } else {
          // Jika bukan karena di-kick (misal, masalah jaringan), coba sambung ulang
          console.log("Koneksi terputus, mencoba menyambung ulang dalam 5 detik...");
          setTimeout(mulaiWebsocket, 5000);
        }
      }
  ws.onmessage = async(e) => {
    console.log(e);
  }
}
mulaiWebsocket();

function kirimPesan(pesan){
  if ( ws.readyState === WebSocket.OPEN){
    ws.send(pesan);
  }
}

// LOGIKA KIRIM pesan
let nilaiTerakhir = {
  belok: 90,
  rodaKiri: 0,
  rodaKanan: 0
};

let pengali = {
  kanan:1,
  kiri:1
};

function kirimPesanRodaKiriKanan(){
  const nilai = Math.round(verticalSliderValue);
  let rodaKanan;
  let rodaKiri;
  let roda;
  let kodeLed;
  if(nilai == 0){
    roda = 0;
    kodeLed = 0;
  } else if(nilai > 0 && nilai < 8){
    roda = 230;
  } else if (nilai >= 8) {
    roda = 255;
  } else if(nilai < 0){
    roda = -230;
    kodeLed = -1;
  }
  rodaKiri = roda * pengali.kiri;
  rodaKanan = roda * pengali.kanan;
  if(rodaKiri !== nilaiTerakhir.rodaKiri){
    if (rodaKiri > rodaKanan && kodeLed === 1){
      kodeLed = 2;
    }
    kirimPesan(`b/${Math.round(rodaKiri)}/${kodeLed}`);
    nilaiTerakhir.rodaKiri = rodaKiri;
  }
  if(rodaKanan !== nilaiTerakhir.rodaKanan){
    if (rodaKanan > rodaKiri && kodeLed === 1){
      kodeLed = 2;
    }
    kirimPesan(`c/${Math.round(rodaKanan)}/${kodeLed}`);
    nilaiTerakhir.rodaKanan = rodaKanan;
  }
}

function kirimPesanRodaDepan(){
  const nilai = Math.round(horizontalSliderValue);
  let BelokSaatIni;
  let kodeLed;
  if(nilai == 0){
    BelokSaatIni = 90-35;
    kodeLed = 3;
    pengali.kiri = 0.7;
  } else if(nilai > 0 && nilai < 4) {
    BelokSaatIni = 90-20;
    kodeLed = 4;
    pengali.kiri = 0.85;
  } else if(nilai >= 4 && nilai <= 6){
    BelokSaatIni = 90;
    kodeLed = 5;
    pengali.kiri = 1;
    pengali.kanan = 1;
  } else if(nilai > 6 && nilai < 10){
    BelokSaatIni = 90+20;
    kodeLed = 6;
    pengali.kanan = 0.85;
  } else if(nilai == 10){
    BelokSaatIni = 90+35;
    kodeLed = 7;
    pengali.kanan = 0.7;
  }
  if(nilaiTerakhir.belok !== BelokSaatIni){
    kirimPesan(`a/${BelokSaatIni}/${kodeLed}`);
    nilaiTerakhir.belok = BelokSaatIni;
    kirimPesanRodaKiriKanan();
  }
}

// --- Logika InteractJS ---
function dragMoveListener(event) {
    const target = event.target;
    const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
    const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
    
    target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
    target.setAttribute('data-x', x);
    target.setAttribute('data-y', y);

    const track = target.parentElement;
    if (target.id === 'horizontal-slider') {
        const totalRange = track.offsetWidth - target.offsetWidth;
        const currentPosition = x + (totalRange / 2);
        horizontalSliderValue = Math.max(0, Math.min(10, (currentPosition / totalRange) * 10));
        kirimPesanRodaDepan();
    } else if (target.id === 'vertical-slider') {
        const totalRange = track.offsetHeight - target.offsetHeight;
        const currentPosition = -y;
        verticalSliderValue = Math.max(0, Math.min(10, (currentPosition / totalRange) * 10));
        kirimPesanRodaKiriKanan();
    }
}

function handleDragEvents(selector) {
    interact(selector)
        .on('dragstart', (event) => {
            event.target.classList.add('slider-handle-active');
        })
        .on('dragend', (event) => {
            const target = event.target;
            target.classList.remove('slider-handle-active');

            // Kembalikan ke posisi semula
            target.style.transform = 'translate(0px, 0px)';
            target.setAttribute('data-x', 0);
            target.setAttribute('data-y', 0);

            // Reset nilai data
            if (target.id === 'horizontal-slider') {
                horizontalSliderValue = 5;
                kirimPesanRodaDepan();
            } else if (target.id === 'vertical-slider') {
              verticalSliderValue = 0;
                kirimPesanRodaKiriKanan();
            }
        });
}

interact('#horizontal-slider').draggable({
    lockAxis: 'x', startAxis: 'x',
    modifiers: [interact.modifiers.restrictRect({ restriction: 'parent' })],
    listeners: { move: dragMoveListener }
});

interact('#vertical-slider').draggable({
    lockAxis: 'y', startAxis: 'y',
    modifiers: [interact.modifiers.restrictRect({ restriction: 'parent' })],
    listeners: { move: dragMoveListener }
});

interact('#belakang').on('down',(event) => {
  verticalSliderValue = -1;
  kirimPesanRodaKiriKanan();
}).on('up', (event) => {
  verticalSliderValue = 0;
  kirimPesanRodaKiriKanan();
});

handleDragEvents('#horizontal-slider');
handleDragEvents('#vertical-slider');
  </script>

</body>
</html>